'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.api = undefined;

var _reduxActions = require('redux-actions');

var _immutable = require('immutable');

var toImmutable = function toImmutable(v) {
  return (0, _immutable.fromJS)(v, function (key, value) {
    return _immutable.Iterable.isIndexed(value) ? value.toList() : value.toOrderedMap();
  });
};

var initialState = (0, _immutable.OrderedMap)({
  subsets: (0, _immutable.OrderedMap)()
});

// subset state
var createSubset = function createSubset(state, _ref) {
  var _ref$payload = _ref.payload,
      subset = _ref$payload.subset,
      fresh = _ref$payload.fresh;

  if (!subset) return state;
  var path = ['subsets', subset];
  if (!fresh && state.hasIn(path)) return state;
  var record = (0, _immutable.OrderedMap)({
    id: subset,
    pending: true
  });
  return state.setIn(path, record);
};

var setSubsetData = function setSubsetData(state, _ref2) {
  var subset = _ref2.meta.subset,
      raw = _ref2.payload.raw;

  if (!subset) return state;
  var path = ['subsets', subset];
  if (!state.hasIn(path)) return state; // subset doesnt exist
  return state.updateIn(path, function (subset) {
    return subset.set('data', toImmutable(raw)).set('pending', false).set('error', null);
  });
};

var setSubsetError = function setSubsetError(state, _ref3) {
  var subset = _ref3.meta.subset,
      payload = _ref3.payload;

  if (!subset) return state;
  var path = ['subsets', subset];
  if (!state.hasIn(path)) return state; // subset doesnt exist
  return state.updateIn(path, function (subset) {
    return subset.delete('data').set('error', payload).set('pending', false);
  });
};

var setSubsetOpen = function setSubsetOpen(state, _ref4) {
  var _ref4$meta = _ref4.meta,
      subset = _ref4$meta.subset,
      collection = _ref4$meta.collection;

  if (!subset) return state;
  var path = ['subsets', subset];
  if (!state.hasIn(path)) return state; // subset doesnt exist
  return state.updateIn(path, function (subset) {
    return subset.set('pending', false).set('data', collection ? (0, _immutable.List)() : (0, _immutable.OrderedMap)());
  });
};

var insertSubsetDataItem = function insertSubsetDataItem(state, _ref5) {
  var _ref5$meta = _ref5.meta,
      subset = _ref5$meta.subset,
      collection = _ref5$meta.collection,
      raw = _ref5.payload.raw;

  if (!subset) return state;
  var path = ['subsets', subset];
  if (!state.hasIn(path)) return state; // subset doesnt exist
  var newData = toImmutable(raw);
  return state.updateIn(path, function (subset) {
    return subset.set('pending', false).update('data', function (data) {
      // first event, initialize the value
      if (data == null && collection) return (0, _immutable.List)([newData]);
      // value exists, either push or replace
      return collection ? data.push(newData) : newData;
    });
  });
};

var updateSubsetDataItem = function updateSubsetDataItem(state, _ref6) {
  var _ref6$meta = _ref6.meta,
      subset = _ref6$meta.subset,
      collection = _ref6$meta.collection,
      raw = _ref6.payload.raw;

  if (!subset) return state;
  var path = ['subsets', subset];
  if (!state.hasIn(path)) return state; // subset doesnt exist
  var dataPath = [].concat(path, ['data']);
  if (!state.hasIn(dataPath)) return state; // subset has no data to update
  var next = toImmutable(raw.next);
  return state.updateIn(dataPath, function (data) {
    // not a list item, replace with new value
    if (!collection) return next;

    // list item, find the index and do the update
    var idx = data.findIndex(function (i) {
      return i.get('id') === raw.prev.id;
    });
    if (idx == null) return data; // not our data?
    return data.set(idx, next);
  });
};
var deleteSubsetDataItem = function deleteSubsetDataItem(state, _ref7) {
  var _ref7$meta = _ref7.meta,
      subset = _ref7$meta.subset,
      collection = _ref7$meta.collection,
      raw = _ref7.payload.raw;

  if (!subset) return state;
  var path = ['subsets', subset];
  if (!state.hasIn(path)) return state; // subset doesnt exist
  var dataPath = [].concat(path, ['data']);
  if (!state.hasIn(dataPath)) return state; // subset has no data to update

  // not a list, just wipe the val
  if (!collection) {
    return state.removeIn(dataPath);
  }
  // item in a list, remove the specific item
  return state.updateIn(dataPath, function (data) {
    var idx = data.findIndex(function (i) {
      return i.get('id') === raw.id;
    });
    if (idx == null) return data; // not our data?
    return data.delete(idx);
  });
};

// exported actions
var api = exports.api = (0, _reduxActions.handleActions)({
  'tahoe.request': createSubset,
  'tahoe.failure': setSubsetError,
  'tahoe.success': setSubsetData,
  'tahoe.tail.open': setSubsetOpen,
  'tahoe.tail.insert': insertSubsetDataItem,
  'tahoe.tail.update': updateSubsetDataItem,
  'tahoe.tail.delete': deleteSubsetDataItem
}, initialState);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZWR1Y2Vycy5qcyJdLCJuYW1lcyI6WyJ0b0ltbXV0YWJsZSIsInYiLCJrZXkiLCJ2YWx1ZSIsImlzSW5kZXhlZCIsInRvTGlzdCIsInRvT3JkZXJlZE1hcCIsImluaXRpYWxTdGF0ZSIsInN1YnNldHMiLCJjcmVhdGVTdWJzZXQiLCJzdGF0ZSIsInBheWxvYWQiLCJzdWJzZXQiLCJmcmVzaCIsInBhdGgiLCJoYXNJbiIsInJlY29yZCIsImlkIiwicGVuZGluZyIsInNldEluIiwic2V0U3Vic2V0RGF0YSIsIm1ldGEiLCJyYXciLCJ1cGRhdGVJbiIsInNldCIsInNldFN1YnNldEVycm9yIiwiZGVsZXRlIiwic2V0U3Vic2V0T3BlbiIsImNvbGxlY3Rpb24iLCJpbnNlcnRTdWJzZXREYXRhSXRlbSIsIm5ld0RhdGEiLCJ1cGRhdGUiLCJkYXRhIiwicHVzaCIsInVwZGF0ZVN1YnNldERhdGFJdGVtIiwiZGF0YVBhdGgiLCJuZXh0IiwiaWR4IiwiZmluZEluZGV4IiwiaSIsImdldCIsInByZXYiLCJkZWxldGVTdWJzZXREYXRhSXRlbSIsInJlbW92ZUluIiwiYXBpIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsSUFBTUEsY0FBYyxTQUFkQSxXQUFjLENBQUNDLENBQUQ7QUFBQSxTQUNsQix1QkFBT0EsQ0FBUCxFQUFVLFVBQUNDLEdBQUQsRUFBTUMsS0FBTjtBQUFBLFdBQ1Isb0JBQVNDLFNBQVQsQ0FBbUJELEtBQW5CLElBQTRCQSxNQUFNRSxNQUFOLEVBQTVCLEdBQTZDRixNQUFNRyxZQUFOLEVBRHJDO0FBQUEsR0FBVixDQURrQjtBQUFBLENBQXBCOztBQUtBLElBQU1DLGVBQWUsMkJBQVc7QUFDOUJDLFdBQVM7QUFEcUIsQ0FBWCxDQUFyQjs7QUFJQTtBQUNBLElBQU1DLGVBQWUsU0FBZkEsWUFBZSxDQUFDQyxLQUFELFFBQTJDO0FBQUEsMEJBQWpDQyxPQUFpQztBQUFBLE1BQXRCQyxNQUFzQixnQkFBdEJBLE1BQXNC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QnJCLElBQWhCLEdBQXNCLE1BQXRCLEVBQU47QUFDQSxNQUFJLENBQUNKLE1BQU1LLEtBQU4sQ0FBWW9CLFFBQVosQ0FBTCxFQUE0QixPQUFPekIsS0FBUCxDQUw4RCxDQUtqRDs7QUFFekM7QUFDQSxNQUFJLENBQUNrQixVQUFMLEVBQWlCO0FBQ2YsV0FBT2xCLE1BQU1pQyxRQUFOLENBQWVSLFFBQWYsQ0FBUDtBQUNEO0FBQ0Q7QUFDQSxTQUFPekIsTUFBTWEsUUFBTixDQUFlWSxRQUFmLEVBQXlCLFVBQUNILElBQUQsRUFBVTtBQUN4QyxRQUFNSyxNQUFNTCxLQUFLTSxTQUFMLENBQWUsVUFBQ0MsQ0FBRDtBQUFBLGFBQU9BLEVBQUVDLEdBQUYsQ0FBTSxJQUFOLE1BQWdCbEIsSUFBSUwsRUFBM0I7QUFBQSxLQUFmLENBQVo7QUFDQSxRQUFJb0IsT0FBTyxJQUFYLEVBQWlCLE9BQU9MLElBQVAsQ0FGdUIsQ0FFWDtBQUM3QixXQUFPQSxLQUFLTixNQUFMLENBQVlXLEdBQVosQ0FBUDtBQUNELEdBSk0sQ0FBUDtBQUtELENBakJEOztBQW1CQTtBQUNPLElBQU1PLG9CQUFNLGlDQUFjO0FBQy9CLG1CQUFpQm5DLFlBRGM7QUFFL0IsbUJBQWlCZ0IsY0FGYztBQUcvQixtQkFBaUJMLGFBSGM7QUFJL0IscUJBQW1CTyxhQUpZO0FBSy9CLHVCQUFxQkUsb0JBTFU7QUFNL0IsdUJBQXFCSyxvQkFOVTtBQU8vQix1QkFBcUJRO0FBUFUsQ0FBZCxFQVFoQm5DLFlBUmdCLENBQVoiLCJmaWxlIjoicmVkdWNlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBoYW5kbGVBY3Rpb25zIH0gZnJvbSAncmVkdXgtYWN0aW9ucydcbmltcG9ydCB7IE9yZGVyZWRNYXAsIExpc3QsIGZyb21KUywgSXRlcmFibGUgfSBmcm9tICdpbW11dGFibGUnXG5cbmNvbnN0IHRvSW1tdXRhYmxlID0gKHYpID0+XG4gIGZyb21KUyh2LCAoa2V5LCB2YWx1ZSkgPT5cbiAgICBJdGVyYWJsZS5pc0luZGV4ZWQodmFsdWUpID8gdmFsdWUudG9MaXN0KCkgOiB2YWx1ZS50b09yZGVyZWRNYXAoKVxuICApXG5cbmNvbnN0IGluaXRpYWxTdGF0ZSA9IE9yZGVyZWRNYXAoe1xuICBzdWJzZXRzOiBPcmRlcmVkTWFwKClcbn0pXG5cbi8vIHN1YnNldCBzdGF0ZVxuY29uc3QgY3JlYXRlU3Vic2V0ID0gKHN0YXRlLCB7IHBheWxvYWQ6IHsgc3Vic2V0LCBmcmVzaCB9IH0pID0+IHtcbiAgaWYgKCFzdWJzZXQpIHJldHVybiBzdGF0ZVxuICBjb25zdCBwYXRoID0gWyAnc3Vic2V0cycsIHN1YnNldCBdXG4gIGlmICghZnJlc2ggJiYgc3RhdGUuaGFzSW4ocGF0aCkpIHJldHVybiBzdGF0ZVxuICBjb25zdCByZWNvcmQgPSBPcmRlcmVkTWFwKHtcbiAgICBpZDogc3Vic2V0LFxuICAgIHBlbmRpbmc6IHRydWVcbiAgfSlcbiAgcmV0dXJuIHN0YXRlLnNldEluKHBhdGgsIHJlY29yZClcbn1cblxuY29uc3Qgc2V0U3Vic2V0RGF0YSA9IChzdGF0ZSwgeyBtZXRhOiB7IHN1YnNldCB9LCBwYXlsb2FkOiB7IHJhdyB9IH0pID0+IHtcbiAgaWYgKCFzdWJzZXQpIHJldHVybiBzdGF0ZVxuICBjb25zdCBwYXRoID0gWyAnc3Vic2V0cycsIHN1YnNldCBdXG4gIGlmICghc3RhdGUuaGFzSW4ocGF0aCkpIHJldHVybiBzdGF0ZSAvLyBzdWJzZXQgZG9lc250IGV4aXN0XG4gIHJldHVybiBzdGF0ZS51cGRhdGVJbihwYXRoLCAoc3Vic2V0KSA9PlxuICAgIHN1YnNldFxuICAgICAgLnNldCgnZGF0YScsIHRvSW1tdXRhYmxlKHJhdykpXG4gICAgICAuc2V0KCdwZW5kaW5nJywgZmFsc2UpXG4gICAgICAuc2V0KCdlcnJvcicsIG51bGwpXG4gIClcbn1cblxuY29uc3Qgc2V0U3Vic2V0RXJyb3IgPSAoc3RhdGUsIHsgbWV0YTogeyBzdWJzZXQgfSwgcGF5bG9hZCB9KSA9PiB7XG4gIGlmICghc3Vic2V0KSByZXR1cm4gc3RhdGVcbiAgY29uc3QgcGF0aCA9IFsgJ3N1YnNldHMnLCBzdWJzZXQgXVxuICBpZiAoIXN0YXRlLmhhc0luKHBhdGgpKSByZXR1cm4gc3RhdGUgLy8gc3Vic2V0IGRvZXNudCBleGlzdFxuICByZXR1cm4gc3RhdGUudXBkYXRlSW4ocGF0aCwgKHN1YnNldCkgPT5cbiAgICBzdWJzZXRcbiAgICAgIC5kZWxldGUoJ2RhdGEnKVxuICAgICAgLnNldCgnZXJyb3InLCBwYXlsb2FkKVxuICAgICAgLnNldCgncGVuZGluZycsIGZhbHNlKVxuICApXG59XG5cbmNvbnN0IHNldFN1YnNldE9wZW4gPSAoc3RhdGUsIHsgbWV0YTogeyBzdWJzZXQsIGNvbGxlY3Rpb24gfSB9KSA9PiB7XG4gIGlmICghc3Vic2V0KSByZXR1cm4gc3RhdGVcbiAgY29uc3QgcGF0aCA9IFsgJ3N1YnNldHMnLCBzdWJzZXQgXVxuICBpZiAoIXN0YXRlLmhhc0luKHBhdGgpKSByZXR1cm4gc3RhdGUgLy8gc3Vic2V0IGRvZXNudCBleGlzdFxuICByZXR1cm4gc3RhdGUudXBkYXRlSW4ocGF0aCwgKHN1YnNldCkgPT5cbiAgICBzdWJzZXRcbiAgICAgIC5zZXQoJ3BlbmRpbmcnLCBmYWxzZSlcbiAgICAgIC5zZXQoJ2RhdGEnLCBjb2xsZWN0aW9uID8gTGlzdCgpIDogT3JkZXJlZE1hcCgpKVxuICApXG59XG5cbmNvbnN0IGluc2VydFN1YnNldERhdGFJdGVtID0gKHN0YXRlLCB7IG1ldGE6IHsgc3Vic2V0LCBjb2xsZWN0aW9uIH0sIHBheWxvYWQ6IHsgcmF3IH0gfSkgPT4ge1xuICBpZiAoIXN1YnNldCkgcmV0dXJuIHN0YXRlXG4gIGNvbnN0IHBhdGggPSBbICdzdWJzZXRzJywgc3Vic2V0IF1cbiAgaWYgKCFzdGF0ZS5oYXNJbihwYXRoKSkgcmV0dXJuIHN0YXRlIC8vIHN1YnNldCBkb2VzbnQgZXhpc3RcbiAgY29uc3QgbmV3RGF0YSA9IHRvSW1tdXRhYmxlKHJhdylcbiAgcmV0dXJuIHN0YXRlLnVwZGF0ZUluKHBhdGgsIChzdWJzZXQpID0+XG4gICAgc3Vic2V0XG4gICAgICAuc2V0KCdwZW5kaW5nJywgZmFsc2UpXG4gICAgICAudXBkYXRlKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgLy8gZmlyc3QgZXZlbnQsIGluaXRpYWxpemUgdGhlIHZhbHVlXG4gICAgICAgIGlmIChkYXRhID09IG51bGwgJiYgY29sbGVjdGlvbikgcmV0dXJuIExpc3QoWyBuZXdEYXRhIF0pXG4gICAgICAgIC8vIHZhbHVlIGV4aXN0cywgZWl0aGVyIHB1c2ggb3IgcmVwbGFjZVxuICAgICAgICByZXR1cm4gY29sbGVjdGlvbiA/IGRhdGEucHVzaChuZXdEYXRhKSA6IG5ld0RhdGFcbiAgICAgIH0pXG4gIClcbn1cblxuY29uc3QgdXBkYXRlU3Vic2V0RGF0YUl0ZW0gPSAoc3RhdGUsIHsgbWV0YTogeyBzdWJzZXQsIGNvbGxlY3Rpb24gfSwgcGF5bG9hZDogeyByYXcgfSB9KSA9PiB7XG4gIGlmICghc3Vic2V0KSByZXR1cm4gc3RhdGVcbiAgY29uc3QgcGF0aCA9IFsgJ3N1YnNldHMnLCBzdWJzZXQgXVxuICBpZiAoIXN0YXRlLmhhc0luKHBhdGgpKSByZXR1cm4gc3RhdGUgLy8gc3Vic2V0IGRvZXNudCBleGlzdFxuICBjb25zdCBkYXRhUGF0aCA9IFsgLi4ucGF0aCwgJ2RhdGEnIF1cbiAgaWYgKCFzdGF0ZS5oYXNJbihkYXRhUGF0aCkpIHJldHVybiBzdGF0ZSAvLyBzdWJzZXQgaGFzIG5vIGRhdGEgdG8gdXBkYXRlXG4gIGNvbnN0IG5leHQgPSB0b0ltbXV0YWJsZShyYXcubmV4dClcbiAgcmV0dXJuIHN0YXRlLnVwZGF0ZUluKGRhdGFQYXRoLCAoZGF0YSkgPT4ge1xuICAgIC8vIG5vdCBhIGxpc3QgaXRlbSwgcmVwbGFjZSB3aXRoIG5ldyB2YWx1ZVxuICAgIGlmICghY29sbGVjdGlvbikgcmV0dXJuIG5leHRcblxuICAgIC8vIGxpc3QgaXRlbSwgZmluZCB0aGUgaW5kZXggYW5kIGRvIHRoZSB1cGRhdGVcbiAgICBjb25zdCBpZHggPSBkYXRhLmZpbmRJbmRleCgoaSkgPT4gaS5nZXQoJ2lkJykgPT09IHJhdy5wcmV2LmlkKVxuICAgIGlmIChpZHggPT0gbnVsbCkgcmV0dXJuIGRhdGEgLy8gbm90IG91ciBkYXRhP1xuICAgIHJldHVybiBkYXRhLnNldChpZHgsIG5leHQpXG4gIH0pXG59XG5jb25zdCBkZWxldGVTdWJzZXREYXRhSXRlbSA9IChzdGF0ZSwgeyBtZXRhOiB7IHN1YnNldCwgY29sbGVjdGlvbiB9LCBwYXlsb2FkOiB7IHJhdyB9IH0pID0+IHtcbiAgaWYgKCFzdWJzZXQpIHJldHVybiBzdGF0ZVxuICBjb25zdCBwYXRoID0gWyAnc3Vic2V0cycsIHN1YnNldCBdXG4gIGlmICghc3RhdGUuaGFzSW4ocGF0aCkpIHJldHVybiBzdGF0ZSAvLyBzdWJzZXQgZG9lc250IGV4aXN0XG4gIGNvbnN0IGRhdGFQYXRoID0gWyAuLi5wYXRoLCAnZGF0YScgXVxuICBpZiAoIXN0YXRlLmhhc0luKGRhdGFQYXRoKSkgcmV0dXJuIHN0YXRlIC8vIHN1YnNldCBoYXMgbm8gZGF0YSB0byB1cGRhdGVcblxuICAvLyBub3QgYSBsaXN0LCBqdXN0IHdpcGUgdGhlIHZhbFxuICBpZiAoIWNvbGxlY3Rpb24pIHtcbiAgICByZXR1cm4gc3RhdGUucmVtb3ZlSW4oZGF0YVBhdGgpXG4gIH1cbiAgLy8gaXRlbSBpbiBhIGxpc3QsIHJlbW92ZSB0aGUgc3BlY2lmaWMgaXRlbVxuICByZXR1cm4gc3RhdGUudXBkYXRlSW4oZGF0YVBhdGgsIChkYXRhKSA9PiB7XG4gICAgY29uc3QgaWR4ID0gZGF0YS5maW5kSW5kZXgoKGkpID0+IGkuZ2V0KCdpZCcpID09PSByYXcuaWQpXG4gICAgaWYgKGlkeCA9PSBudWxsKSByZXR1cm4gZGF0YSAvLyBub3Qgb3VyIGRhdGE/XG4gICAgcmV0dXJuIGRhdGEuZGVsZXRlKGlkeClcbiAgfSlcbn1cblxuLy8gZXhwb3J0ZWQgYWN0aW9uc1xuZXhwb3J0IGNvbnN0IGFwaSA9IGhhbmRsZUFjdGlvbnMoe1xuICAndGFob2UucmVxdWVzdCc6IGNyZWF0ZVN1YnNldCxcbiAgJ3RhaG9lLmZhaWx1cmUnOiBzZXRTdWJzZXRFcnJvcixcbiAgJ3RhaG9lLnN1Y2Nlc3MnOiBzZXRTdWJzZXREYXRhLFxuICAndGFob2UudGFpbC5vcGVuJzogc2V0U3Vic2V0T3BlbixcbiAgJ3RhaG9lLnRhaWwuaW5zZXJ0JzogaW5zZXJ0U3Vic2V0RGF0YUl0ZW0sXG4gICd0YWhvZS50YWlsLnVwZGF0ZSc6IHVwZGF0ZVN1YnNldERhdGFJdGVtLFxuICAndGFob2UudGFpbC5kZWxldGUnOiBkZWxldGVTdWJzZXREYXRhSXRlbVxufSwgaW5pdGlhbFN0YXRlKVxuIl19